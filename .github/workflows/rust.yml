name: Rust tests

on:
  push:
    paths:
      - 'rust/**'
      - '.github/workflows/rust.yml'

env:
  CARGO_TERM_COLOR: always

jobs:
  test_rust:
    name: Test Rust
    runs-on: ubuntu-latest
    if: |
      ! contains(github.event.head_commit.message, '[ci skip]') &&
      ! contains(github.event.head_commit.message, '[skip ci]')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Get Rust projects
        id: rust-projects
        run: |
          dirs=$(find rust -mindepth 1 -maxdepth 1 -type d -exec basename {} \;)
          echo "Subdirectories found: $dirs"
          echo $dirs >> $GITHUB_OUTPUT
      - name: Cache Rust files
        uses: swatinem/rust-cache@v2
        with:
          workspaces: |
            short-fibonacci
            leap
            beer-song
            bob
            hamming
            resistor-color
            hello-world
            nth-prime
            proverb
            lucians-luscious-lasagna
            health-statistics
            sum-of-multiples
            difference-of-squares
            high-scores
            semi-structured-logs
            grains
            armstrong-numbers
            reverse-string
            pascals-triangle
            raindrops
            assembly-line
            gigasecond
      - name: Run the tests
        run: |
          cd rust
          ../bin/test_all.sh "Cargo.toml" "cargo test"
